# 【推荐系统】阿里定向广告模型简介-DIN以及Attention

淘宝的定向广告模型在DNN中使用Embedding来表示用户兴趣之后，发现并不能很好的去表示用户的兴趣相关。所以在下一个版本的定向广告模型中，引入了Attention机制。Attention机制来源于人类最自然的选择性注意的习惯，比如在浏览网页时，会选择性的注意页面的特定区域，忽视其他区域。

## 1. Attention

Attention机制最早的提出是针对与序列模型的，出处是Bengio大神在2015年的*Neural Machine Translation by jointly learning to align and translate*. 我们要说attention机制其实是借鉴了生物在观察和学习行为中的过程，也就是说我们人来通常在观察和学习的时候，都是通过快速的获取全局的信息，建立起对于事物的需要重点观察或者学习的区域，这些需要重点关注的目标区域，就是我们注意力的焦点。然而，就和我们日常生活中处理事情一样，我们没有办法同时处理所有的事情，我们会给他们分出优先级。同样的，注意力也会有一个权重值，从而更专注的聚焦在某些关键的信息上。

在计算机视觉中比较直观的体现就是人眼的聚焦在图片上不同的内容上面，同时其他的物品就被虚化且忽略了。而在自然语言处理中针对某个单词，就会在处理目标token时，能够考虑上下文信息。

在推荐系统领域中，引入attention的模型是浙江大学的AFM和阿里巴巴的DIN。

## 2. DIN模型

DIN模型的应用场景是阿里巴巴的电商广告推荐，因此在计算一个用户u是否点击一个广告a时，模型的输入特征分为两大部分，一部分是用户u的特征组，另一个是候选广告a的特征组。无论是用户还是广告，都含有两个非常重要的特征——商品id（good_id）和商铺id（shop_id）。用户特征里的商品id是一个序列，代表用户曾经点击过的商品集合，商铺id是同理；而广告特征里的商品id和商铺id就是广告对应的商品id和商铺id。

![](https://gitee.com/zhanghang23/picture_bed/raw/master/recommendation_system/taobao_advertisement/din1.png)

上图是DIN的base模型，用户特征组中商品序列和商铺序列经过简单的平均池化操作后就进入上层神经网络进行下一步的训练，序列中的商品基于没有区分重要成程度，也和广告特征中的商品id没有关系。

然而事实上，广告特征和用户特征的关联程度是非常强的，比如“鼠标”这个历史商品的id对预测“键盘”广告的点击率肯定是远大于牛奶。而从模型的角度上来说，在建模过程中投给不同特征的“注意力”理应也有所不同，而且“注意力得分”的计算力迎合广告特征有相关性。

![](https://gitee.com/zhanghang23/picture_bed/raw/master/recommendation_system/taobao_advertisement/din.png)

将上述“注意力”的思想反映到模型中也是直观的。利用候选商品和历史行为商品之间的相关性计算出一个权重，这个权重就代表了“注意力”的强弱，加入了注意力全忠的深度学习网络就是DIN模型，其中注意力部分的形式表达为：
$$
V_u=f(V_a)=\sum_{N}^{i=1}w_i\cdot V_i =\sum_{N}^{i=1}g(V_i, V_a)\cdot V_i
$$
其中，$V_u$是用户的Embedding向量，$V_a$是候选广告商品的Embedding向量，$V_i$是用户u的第i次行为的Embedding向量。这里用户的行为就是浏览商品或店铺，因此行为的Embedding向量就是那次浏览的商品或店铺的Embedding向量。

因为加入了注意力记住，所以$V_u$从过去$V_i$的加和变成了$V_i$的加权和，$V_i$的权重$w_i$就由$V_i$与$V_a$的关系决定，也就是上面公式中的$g(V_i,V_a)$，即“注意力得分”。而这个得分是用一个注意力激活单元（activation unit）来生成注意力得分。这个注意力激活单元本质上也是一个效地神经网络，其具体结构如下。

![](https://gitee.com/zhanghang23/picture_bed/raw/master/recommendation_system/taobao_advertisement/din_au.jpg)

这里可以看出，激活单元的输入层是两个Embedding向量， 经过元素减操作后，余元Embedding向量一同连接后形成全连接层的输入，最后通过单神经元输出层生成注意力得分。

# 3. 总结

DIN模型相对于AFM，是一次更典型的改进深度学习网络的尝试，而且由于出发点是具体的业务场景，也给了推荐工程师更多实质性的启发。而在之后对于DIN的改进模型就是DIEN，这里的创新在于用序列模型模拟出了用户的兴趣进化过程。我准备再开一篇文章中再进行DIEN的分析。